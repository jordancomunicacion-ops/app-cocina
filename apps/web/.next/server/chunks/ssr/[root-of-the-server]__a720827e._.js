module.exports=[93695,(a,b,c)=>{b.exports=a.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},95044,a=>{a.n(a.i(52425))},8318,a=>{a.n(a.i(54944))},44665,a=>{a.n(a.i(28992))},43619,a=>{a.n(a.i(79962))},13718,a=>{a.n(a.i(85523))},18198,a=>{a.n(a.i(45518))},62212,a=>{a.n(a.i(66114))},68268,a=>{a.n(a.i(18224))},65716,a=>{"use strict";var b=a.i(7997),c=a.i(73794);async function d(a,b){let d=await c.prisma.event.findMany({where:{date:{gte:a,lte:b},status:"CONFIRMED"},include:{menuItems:{include:{recipe:{include:{items:{include:{ingredient:!0,subRecipe:{include:{items:{include:{ingredient:!0}}}}}}}}}}}}),e=new Map,f=(a,b,c,d)=>{let f=e.get(a)||{ingredientId:a,ingredientName:b,quantity:0,unit:d};f.quantity+=c,e.set(a,f)};d.forEach(a=>{a.menuItems.forEach(b=>{let c=(b.servingsOverride||a.pax)/b.recipe.yieldQuantity*a.safetyMargin;b.recipe.items.forEach(a=>{if("INGREDIENT"===a.type&&a.ingredient)f(a.ingredient.id,a.ingredient.name,a.quantityGross*c,a.unit);else if("SUB_RECIPE"===a.type&&a.subRecipe){let b=a.quantityGross/a.subRecipe.yieldQuantity*c;a.subRecipe.items.forEach(a=>{"INGREDIENT"===a.type&&a.ingredient&&f(a.ingredient.id,a.ingredient.name,a.quantityGross*b,a.unit)})}})})});let g=Array.from(e.values()),h=[];for(let a of g){let b=await c.prisma.transformation.findMany({where:{outputs:{some:{ingredientId:a.ingredientId}}},include:{sourceProduct:!0,outputs:{include:{ingredient:!0}}}});if(0===b.length){h.push({type:"DIRECT",productName:a.ingredientName,quantityToBuy:a.quantity,reason:"Compra directa (sin transformación conocida)",score:100,coveredIngredients:[{name:a.ingredientName,quantity:a.quantity,percentage:100}],wasteOrSurplus:[]});continue}let d=null,f=-1;for(let c of b){let b=c.outputs.find(b=>b.ingredientId===a.ingredientId);if(!b)continue;let g=b.percentage,h=a.quantity/(g/100),i=a.quantity,j=[{name:a.ingredientName,quantity:a.quantity,percentage:g}],k=[];c.outputs.forEach(b=>{if(b.ingredientId===a.ingredientId)return;let c=h*(b.percentage/100),d=e.get(b.ingredientId||"");if(d){let a=Math.min(c,d.quantity);i+=a,j.push({name:b.ingredient?.name,quantity:a,percentage:b.percentage}),c>d.quantity&&k.push({name:b.ingredient?.name||"Unknown",quantity:c-d.quantity})}else k.push({name:b.ingredient?.name||"Unknown",quantity:c})});let l=i/h*100;l>f&&(f=l,d={trans:c,rawProductNeeded:h,score:l,covered:j,waste:k})}d&&h.push({type:"TRANSFORMATION",productId:d.trans.sourceProduct.id,productName:d.trans.sourceProduct.name,supplier:d.trans.sourceProduct.supplier||void 0,quantityToBuy:d.rawProductNeeded,reason:`Mejor aprovechamiento (${d.score.toFixed(0)}%). Cubre: ${d.covered.map(a=>a.name).join(", ")}`,score:d.score,coveredIngredients:d.covered,wasteOrSurplus:d.waste})}return h}async function e({searchParams:a}){let c=await a,e=c?.start?new Date(c.start):new Date,f=new Date(c?.end?c.end:new Date().setDate(new Date().getDate()+30)),g=await d(e,f);return(0,b.jsxs)("main",{children:[(0,b.jsx)("h1",{className:"mb-4 text-2xl font-bold",children:"Planificación de Compras"}),(0,b.jsxs)("p",{className:"mb-8 text-gray-500",children:["Análisis de necesidades basado en eventos confirmados (",e.toLocaleDateString()," - ",f.toLocaleDateString(),")."]}),(0,b.jsx)("div",{className:"grid gap-6 lg:grid-cols-2",children:(0,b.jsx)("div",{className:"lg:col-span-2",children:(0,b.jsxs)("div",{className:"overflow-hidden rounded-xl bg-white shadow-sm ring-1 ring-gray-900/5",children:[(0,b.jsx)("div",{className:"border-b border-gray-200 bg-gray-50 px-4 py-3 sm:px-6",children:(0,b.jsx)("h3",{className:"text-base font-semibold leading-6 text-gray-900",children:"Recomendaciones de Compra"})}),(0,b.jsxs)("ul",{role:"list",className:"divide-y divide-gray-100",children:[0===g.length&&(0,b.jsx)("li",{className:"p-6 text-center text-gray-500 italic",children:"No hay necesidades detectadas para este periodo."}),g.map((a,c)=>(0,b.jsxs)("li",{className:"flex flex-wrap items-center justify-between gap-x-6 gap-y-4 py-5 sm:flex-nowrap px-6 hover:bg-gray-50",children:[(0,b.jsxs)("div",{className:"flex-grow",children:[(0,b.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,b.jsx)("p",{className:"text-sm font-semibold leading-6 text-gray-900",children:a.productName}),"TRANSFORMATION"===a.type&&(0,b.jsxs)("span",{className:"inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20",children:["Optimización (",a.score.toFixed(0),"%)"]}),"DIRECT"===a.type&&(0,b.jsx)("span",{className:"inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10",children:"Directo"})]}),(0,b.jsx)("div",{className:"mt-1 flex items-center gap-x-2 text-xs leading-5 text-gray-500",children:(0,b.jsx)("p",{children:a.reason})})]}),(0,b.jsxs)("div",{className:"flex flex-none items-center gap-x-4",children:[(0,b.jsxs)("div",{className:"flex flex-col items-end",children:[(0,b.jsxs)("p",{className:"text-sm font-bold text-gray-900",children:[a.quantityToBuy.toFixed(2)," KG"]})," ",a.supplier&&(0,b.jsx)("p",{className:"text-xs text-gray-500",children:a.supplier})]}),(0,b.jsx)("button",{className:"rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50",children:"Añadir"})]}),(0,b.jsx)("div",{className:"w-full mt-2 pl-4 border-l-2 border-gray-100",children:(0,b.jsxs)("details",{className:"group",children:[(0,b.jsx)("summary",{className:"flex cursor-pointer items-center text-xs font-medium text-blue-600 hover:text-blue-800",children:"Ver detalle de uso"}),(0,b.jsxs)("div",{className:"mt-2 space-y-1 text-xs text-gray-600",children:[(0,b.jsx)("p",{className:"font-semibold text-gray-900",children:"Cubierto:"}),a.coveredIngredients.map((a,c)=>(0,b.jsxs)("p",{children:["- ",a.name,": ",a.quantity.toFixed(2)," (",a.percentage,"%)"]},c)),a.wasteOrSurplus.length>0&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("p",{className:"font-semibold text-gray-900 mt-2",children:"Excedente / Merma:"}),a.wasteOrSurplus.map((a,c)=>(0,b.jsxs)("p",{className:"text-orange-600",children:["- ",a.name,": ",a.quantity.toFixed(2)]},c))]})]})]})})]},c))]})]})})})]})}a.s(["default",()=>e],65716)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a720827e._.js.map